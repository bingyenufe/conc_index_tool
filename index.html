<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>洛伦兹与集中曲线分析工具 (最终版)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background-color: #f4f6f8; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; margin-bottom: 5px; }
        p.subtitle { text-align: center; color: #666; font-size: 0.9rem; margin-bottom: 25px; }

        /* 表格样式 */
        .table-container { overflow-x: auto; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 10px; text-align: center; border-bottom: 1px solid #ddd; }
        th { background-color: #f1f3f5; color: #495057; font-weight: 600; }
        input[type="number"] { width: 90%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; text-align: center; font-size: 1rem; transition: border 0.2s;}
        input[type="number"]:focus { border-color: #007bff; outline: none; }

        /* 操作区域 */
        .action-area { background-color: #e3f2fd; padding: 25px; border-radius: 8px; border: 1px solid #bbdefb; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        
        .input-wrapper { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; justify-content: center; }
        .input-wrapper label { font-weight: bold; color: #0d47a1; font-size: 1.1rem; }
        .input-wrapper input { width: 180px; padding: 10px; border: 2px solid #2196f3; border-radius: 5px; font-weight: bold; color: #0d47a1; }

        /* 大按钮 */
        .submit-btn { 
            padding: 12px 40px; 
            background-color: #007bff; 
            color: white; 
            border: none; 
            border-radius: 50px; 
            font-size: 1.1rem; 
            font-weight: bold; 
            cursor: pointer; 
            box-shadow: 0 4px 6px rgba(0,123,255,0.3);
            transition: all 0.2s;
        }
        .submit-btn:hover { background-color: #0056b3; transform: translateY(-2px); box-shadow: 0 6px 8px rgba(0,123,255,0.4); }
        .submit-btn:active { transform: translateY(0); }

        /* 结果展示区 */
        .result-panel { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; }
        .result-card { padding: 20px; border-radius: 8px; text-align: center; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        /* 左侧：基尼系数 (蓝色) */
        .result-card.gini { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); background-color: #007bff;}
        /* 右侧：校验结果 (默认灰色，正确绿色，错误红色) */
        .result-card.verify { background-color: #6c757d; transition: background-color 0.3s; }
        
        .card-label { font-size: 1rem; opacity: 0.9; margin-bottom: 5px; }
        .card-value { font-size: 2rem; font-weight: bold; letter-spacing: 1px; }

        /* 图表区 */
        .canvas-container { margin-top: 30px; position: relative; height: 500px; width: 100%; border: 1px solid #eee; border-radius: 8px; padding: 10px; background: white;}
    </style>
</head>
<body>

<div class="container">
    <h1>洛伦兹曲线 & 集中曲线分析</h1>
    <p class="subtitle">输入数据 -> 输入你的计算结果 -> 点击提交验证</p>
    
    <!-- 1. 数据输入表格 -->
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th style="width: 10%">点序号</th>
                    <th style="width: 30%">累积人口比 (X<sub>i</sub>)</th>
                    <th style="width: 30%">累积收入比 (Y<sub>i</sub>) <span style="color:#007bff; font-size:0.8em">●</span></th>
                    <th style="width: 30%">累积支出比 (C<sub>i</sub>) <span style="color:#28a745; font-size:0.8em">●</span></th>
                </tr>
            </thead>
            <tbody id="inputBody">
                <!-- 预设5个点 -->
                <tr><td>1</td><td><input type="number" step="0.01" value="0.20"></td><td><input type="number" step="0.01" value="0.04"></td><td><input type="number" step="0.01" value="0.10"></td></tr>
                <tr><td>2</td><td><input type="number" step="0.01" value="0.40"></td><td><input type="number" step="0.01" value="0.12"></td><td><input type="number" step="0.01" value="0.25"></td></tr>
                <tr><td>3</td><td><input type="number" step="0.01" value="0.60"></td><td><input type="number" step="0.01" value="0.28"></td><td><input type="number" step="0.01" value="0.45"></td></tr>
                <tr><td>4</td><td><input type="number" step="0.01" value="0.80"></td><td><input type="number" step="0.01" value="0.55"></td><td><input type="number" step="0.01" value="0.70"></td></tr>
                <tr><td>5</td><td><input type="number" step="0.01" value="1.00"></td><td><input type="number" step="0.01" value="1.00"></td><td><input type="number" step="0.01" value="1.00"></td></tr>
            </tbody>
        </table>
    </div>

    <!-- 2. 操作与校验区域 -->
    <div class="action-area">
        <div class="input-wrapper">
            <label for="userCI">请输入你计算的集中指数 (CI):</label>
            <input type="number" id="userCI" step="0.0001" placeholder="如: 0.1234">
        </div>
        <!-- 提交按钮 -->
        <button class="submit-btn" onclick="calculateAndVerify()">提交：绘制图表并校验结果</button>
    </div>

    <!-- 3. 结果显示区域 -->
    <div class="result-panel">
        <!-- 直接显示基尼系数数值 -->
        <div class="result-card gini">
            <div class="card-label">基尼系数 (Gini Coefficient)</div>
            <div id="giniResult" class="card-value">---</div>
        </div>
        <!-- 显示校验结果 -->
        <div class="result-card verify" id="verifyCard">
            <div class="card-label">集中指数校验结果</div>
            <div id="verifyResult" class="card-value">等待提交</div>
        </div>
    </div>

    <!-- 4. 图表 -->
    <div class="canvas-container">
        <canvas id="mainChart"></canvas>
    </div>
</div>

<script>
    let myChart = null;

    // 页面加载时先画个空图，或者带默认数据的图
    window.onload = function() {
        // 可以在这里初始化，也可以等用户点按钮
        // 这里为了美观，先不执行计算，只等用户点击
    };

    function calculateAndVerify() {
        const rows = document.querySelectorAll('#inputBody tr');
        let dataPoints = [];

        // 1. 获取表格数据
        rows.forEach(row => {
            const inputs = row.querySelectorAll('input');
            const x = parseFloat(inputs[0].value);
            const y_lorenz = parseFloat(inputs[1].value); // 收入
            const y_conc = parseFloat(inputs[2].value);   // 支出

            // 只有当三个数都有效时才添加
            if (!isNaN(x) && !isNaN(y_lorenz) && !isNaN(y_conc)) {
                dataPoints.push({ x: x, yL: y_lorenz, yC: y_conc });
            }
        });

        if (dataPoints.length < 2) {
            alert("请至少输入两组有效数据！");
            return;
        }

        // 2. 数据处理：排序与补全 (0,0) (1,1)
        dataPoints.sort((a, b) => a.x - b.x); 

        // 补全起点 (0,0)
        if (dataPoints[0].x > 0) {
            dataPoints.unshift({ x: 0, yL: 0, yC: 0 });
        } else {
            // 确保起点为0
            dataPoints[0] = { x: 0, yL: 0, yC: 0 }; 
        }

        // 补全终点 (1,1)
        const last = dataPoints[dataPoints.length - 1];
        if (last.x < 1) {
            if(Math.abs(last.x - 1) > 0.001) {
                // 如果最后一个点离1很远，添加(1,1)
                dataPoints.push({ x: 1, yL: 1, yC: 1 });
            } else {
                // 离1很近，强制设为1
                dataPoints[dataPoints.length - 1].x = 1;
                dataPoints[dataPoints.length - 1].yL = 1; 
                // 集中曲线终点通常为1，但也可能不是，这里为了绘图闭合，默认设为1
                dataPoints[dataPoints.length - 1].yC = 1; 
            }
        }

        // 3. 计算指标
        // 基尼系数
        const gini = calculateIndex(dataPoints, 'yL');
        // 集中指数 (真实值，用于校验)
        const actualCI = calculateIndex(dataPoints, 'yC');

        // 4. 更新界面显示
        
        // 4.1 显示基尼系数 (直接显示数值)
        document.getElementById('giniResult').innerText = gini.toFixed(4);

        // 4.2 校验用户输入的集中指数
        const userCIInput = document.getElementById('userCI').value;
        const verifyCard = document.getElementById('verifyCard');
        const verifyText = document.getElementById('verifyResult');
        
        if (userCIInput === "") {
            verifyCard.style.backgroundColor = "#ffc107"; // 黄色警告
            verifyText.innerText = "请输入数值";
            verifyText.style.fontSize = "1.5rem";
        } else {
            const userCI = parseFloat(userCIInput);
            const diff = Math.abs(actualCI - userCI);
            
            // 允许误差 0.01
            if (diff <= 0.01) {
                verifyCard.style.backgroundColor = "#28a745"; // 绿色成功
                verifyText.innerText = "计算正确 ✅";
            } else {
                verifyCard.style.backgroundColor = "#dc3545"; // 红色错误
                verifyText.innerText = "计算错误 ❌";
            }
        }

        // 5. 绘制图表
        drawChart(dataPoints);
    }

    // 梯形面积法计算指数: G = 1 - 2 * Area
    function calculateIndex(points, yKey) {
        let areaB = 0;
        for (let i = 1; i < points.length; i++) {
            const width = points[i].x - points[i-1].x;
            const height = (points[i][yKey] + points[i-1][yKey]) / 2;
            areaB += width * height;
        }
        return 1 - (2 * areaB);
    }

    function drawChart(data) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        
        // 准备Chart.js数据格式
        const lorenzData = data.map(p => ({x: p.x, y: p.yL}));
        const concData = data.map(p => ({x: p.x, y: p.yC}));
        const equalityLine = [{x: 0, y: 0}, {x: 1, y: 1}];

        if (myChart) {
            myChart.destroy();
        }

        myChart = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [
                    {
                        label: '45度绝对平均线',
                        data: equalityLine,
                        borderColor: '#999',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        showLine: true,
                        pointRadius: 0,
                        fill: false
                    },
                    {
                        label: '洛伦兹曲线 (收入)',
                        data: lorenzData,
                        borderColor: '#00f2fe', // 亮蓝色
                        backgroundColor: 'rgba(0, 242, 254, 0.1)',
                        borderWidth: 3,
                        showLine: true,
                        fill: true,
                        tension: 0.1
                    },
                    {
                        label: '集中曲线 (支出)',
                        data: concData,
                        borderColor: '#28a745', // 绿色
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        borderWidth: 3,
                        showLine: true,
                        fill: true,
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom',
                        title: { display: true, text: '累积人口比 (按收入排序)' },
                        min: 0, max: 1
                    },
                    y: {
                        title: { display: true, text: '累积比率' },
                        min: 0, max: 1
                    }
                },
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                }
            }
        });
    }
</script>

</body>

</html>
